name: Sync Linux Kernel Version

on:
  schedule:
    - cron: '0 4 * * *'       # ogni giorno alle 4:00 UTC
  workflow_dispatch:          # esecuzione manuale

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0       # serve per leggere la versione dal commit precedente

      - name: Get latest upstream tag
        id: upstream
        run: |
          latest=$(git ls-remote --tags https://github.com/torvalds/linux.git \
            | awk -F/ '/refs\/tags\/v[0-9]+\.[0-9]+\.[0-9]+$/ {print $3}' \
            | sort -V | tail -1)
          echo "Upstream latest tag: $latest"
          echo "::set-output name=latest::$latest"

      - name: Get current pkgver
        id: current
        run: |
          pkgver=$(grep '^pkgver=' PKGBUILD | cut -d= -f2)
          echo "::set-output name=pkgver::$pkgver"

      - name: Bump pkgver & reset pkgrel
        if: steps.upstream.outputs.latest != steps.current.outputs.pkgver
        run: |
          echo "Bumping from ${{ steps.current.outputs.pkgver }} to ${{ steps.upstream.outputs.latest }}"
          sed -i "s/^pkgver=.*/pkgver=${{ steps.upstream.outputs.latest }}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          makepkg --printsrcinfo > .SRCINFO

      - name: Commit & push changes
        if: steps.upstream.outputs.latest != steps.current.outputs.pkgver
        uses: EndBug/add-and-commit@v9
        with:
          author_name: "github-actions[bot]"
          author_email: "github-actions[bot]@users.noreply.github.com"
          message: "ci: sync to kernel v${{ steps.upstream.outputs.latest }}"
          add: |
            PKGBUILD
            .SRCINFO
          push: true
